
## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **프로젝트명** | BaleMale 자율주차 로봇 |
| **목적** | 차량 적재 → 자율주행 → 주차 → 하역의 완전 자동화 |
| **플랫폼** | ROS2 Humble + Jetson Orin Nano |
| **주행방식** | ArUco 마커 기반 비전 네비게이션 |

---

## 2. 하드웨어 구성

### 2.1 메인 컴퓨팅

| 부품 | 역할 |
|------|------|
| **Jetson Orin Nano** | 메인 컴퓨터 (ROS2, 영상처리, AI) |
| **Arduino UNO (모터)** | 메카넘 휠 PWM 제어 (PCA9685) |

### 2.2 센서

| 센서 | 용도 | 사양 |
|------|------|------|
| **Logitech C920** | 전방 카메라 (마커 인식) | 640x480 @ 30fps |
| **Brio 100** | 측면 카메라 (주차 정렬) | 640x480 @ 30fps |
| **MPU6050** | IMU (회전 제어) | 100Hz, I2C Bus 7 |

### 2.3 액추에이터

| 부품 | 사양 |
|------|------|
| **메카넘 휠 4개** | DC 모터 + PCA9685 PWM 드라이버 |

### 2.4 하드웨어 구성도

```
┌─────────────────────────────────────────────────────┐
│                 Jetson Orin Nano                    │
│    ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│    │ ROS2     │  │ OpenCV   │  │ MQTT     │        │
│    │ Humble   │  │ ArUco    │  │ Client   │        │
│    └────┬─────┘  └────┬─────┘  └────┬─────┘        │
└─────────┼─────────────┼─────────────┼──────────────┘
          │             │             │
    ┌─────▼─────┐ ┌─────▼─────┐ ┌─────▼─────┐
    │ Arduino   │ │ Camera x2 │ │ EC2 Server│
    │ UNO       │ │ Front/Side│ │ (MQTT)    │
    └─────┬─────┘ └───────────┘ └───────────┘
          │
    ┌─────▼─────┐     ┌───────────┐
    │ PCA9685   │────▶│ Mecanum   │
    │ PWM Driver│     │ Wheels x4 │
    └───────────┘     └───────────┘
```

### 2.5 메카넘 휠 배치

```
        전방 (Front)
    ┌───────────────┐
    │  FL ↘   ↙ FR  │
    │   A       B   │
    │               │
    │   C       D   │
    │  RL ↗   ↖ RR  │
    └───────────────┘
        후방 (Rear)

Motor A (FL): SIGN=-1, Scale=1.0
Motor B (FR): SIGN=+1, Scale=1.0 
Motor C (RL): SIGN=-1, Scale=1.0
Motor D (RR): SIGN=+1, Scale=1.0
```

---

## 3. 소프트웨어 아키텍처

### 3.1 패키지 구조

```
src/
├── drivers/                    # 하드웨어 드라이버
│   ├── camera_driver/          # USB 카메라 (V4L2)
│   ├── arduino_driver/         # 모터 시리얼 통신
│   ├── imu_driver/             # MPU6050 I2C
│   └── loader_driver/          # 리프트 제어
│
├── perception/                 # 인식 시스템
│   ├── marker_detector/        # ArUco 마커 검출
│   ├── marker_tracker/         # 칼만 필터 추적
│   ├── anpr_detector/          # 번호판 인식 (YOLOv8)
│   ├── lane_detector/          # 라인 검출 (미사용)
│   └── slot_line_detector/     # 주차선 검출 (미사용)
│
├── control/
│   └── motion_controller/      # 모션 제어 (주행/회전/주차)
│
├── planning/
│   ├── mission_manager/        # FSM 미션 관리
│   └── server_bridge/          # MQTT ↔ ROS2 브릿지
│
├── interfaces/
│   └── robot_interfaces/       # 커스텀 메시지 20+종
│
└── bringup/
    └── robot_bringup/          # 런치 파일, 설정
```

### 3.2 노드 구성도

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  cam_front  │────▶│marker_detect│────▶│marker_track │
│  (카메라)   │     │  (ArUco)    │     │  (칼만필터) │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
┌─────────────┐     ┌─────────────┐     ┌──────▼──────┐
│  cam_side   │────▶│side_marker  │────▶│  mission    │
│  (측면카메라)│     │  (주차마커) │     │  manager    │
└─────────────┘     └─────────────┘     │   (FSM)     │
                                        └──────┬──────┘
┌─────────────┐     ┌─────────────┐            │
│  imu_node   │────▶│   motion    │◀───────────┘
│  (MPU6050)  │     │ controller  │
└─────────────┘     └──────┬──────┘
                           │
                    ┌──────▼──────┐     ┌─────────────┐
                    │   arduino   │────▶│  Mecanum    │
                    │   driver    │     │  Wheels     │
                    └─────────────┘     └─────────────┘
```

### 3.3 미션 FSM (유한 상태 기계)

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  WAIT_VEHICLE ──▶ RECOGNIZE ──▶ LOAD ──▶ DRIVE ──▶ PARK    │
│       ▲              │                              │       │
│       │              ▼                              ▼       │
│       │           (ERROR)                        UNLOAD     │
│       │                                             │       │
│       └──────────── RETURN_HOME ◀───────────────────┘       │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

#### 상태별 설명

| 상태 | 설명 | 타임아웃 |
|------|------|----------|
| **WAIT_VEHICLE** | 홈 위치 대기, ANPR 모니터링 | - |
| **RECOGNIZE** | 서버에 번호판 조회, 슬롯 배정 | 60초 |
| **LOAD** | 리프트로 차량 적재 | 30초 |
| **DRIVE** | 마커 따라 자율주행 | 120초 |
| **PARK** | 주차 슬롯에 정밀 주차 | 30초 |
| **UNLOAD** | 차량 하역 | 30초 |
| **RETURN_HOME** | 홈으로 복귀 | 120초 |

#### 주행 서브상태

```
DRIVE → STOP_AT_MARKER → ADVANCE_TO_CENTER → STOP_BUMP → TURNING → ALIGN_TO_MARKER → DRIVE
```

#### 주차 서브상태

```
PARK_DETECT → PARK_ALIGN_MARKER → PARK_ALIGN_RECT → PARK_FINAL → FINISH
      │
      └──▶ PARK_RECOVERY (잘못된 위치시)
```

---

## 4. 개발 진행 과정 (Git History 기반)

### Phase 1: 기초 설계

| 단계 | 커밋 | 내용 |
|------|------|------|
| 0 | `Phase 0` | GitHub 리서치 및 Best Practices 조사 |
| 1 | `Phase 1` | 전체 아키텍처 설계 |
| 2 | `Phase 2` | 인터페이스 정의 (메시지, 서비스, 액션) |
| 3 | `Phase 3` | 드라이버 노드 개발 (카메라, 아두이노) |
| 4 | `Phase 4` | 인식 노드 개발 (마커 검출) |
| 5 | `Phase 5` | 제어 노드 개발 |
| 6 | `Phase 6` | 플래닝/미션 노드 개발 |
| 7-9 | `Phase 7-9` | 런치 파일, 테스트, 문서화 |

### Phase 2: 주행 시스템 개발

| 커밋 | 내용 |
|------|------|
| `lane+marker_update` | 라인 + 마커 복합 인식 시스템 구현 |
| `turn까지완료` | IMU 기반 회전 제어 완성 |
| `NO_PID` | PID 제어 제거, 단순 비례제어로 변경 |
| `주행UPGRADE` | 주행 알고리즘 전면 개선 |
| `주행완성` | 마커 기반 자율주행 완성 |

### Phase 3: 주차/적재 시스템

| 커밋 | 내용 |
|------|------|
| `add PARKING+LOADING` | 주차 로직 + 적재 기능 추가 |
| `AI_node Upload` | ANPR(번호판 인식) AI 노드 결합 |
| `loading통합완료` | 로더(리프트) 시스템 통합 완료 |
| `server_test완` | MQTT 서버 연동 테스트 완료 |
| `주행주차 완성` | 전체 미션 플로우 완성 |

### Phase 4: 버그 수정 및 최적화

| 커밋 | 문제 | 해결 |
|------|------|------|
| `7.4V 배터리 보상` | 저전압시 모터 출력 부족 | MAX_PWM 파라미터 추가 |
| `마커 기반 회전 종료` | 회전 후 마커 정렬 불량 | 마커 기반 정렬 로직 개선 |
| `RETURN_HOME 역순 복귀` | 복귀 경로 계산 오류 | 왔던 길 역순 계산 구현 |
| `불필요한 TURNING 제거` | 마지막 waypoint에서 불필요한 회전 | 조건문 수정 |

### Phase 5: 완성 및 고도화

| 커밋 | 내용 |
|------|------|
| `이상탐지_거리기반` | 장애물/사람 감지 기능 추가 |
| `출차로직추가` | 차량 출차(반출) 로직 구현 |
| `입차초기/출차마지막_수정` | 입출차 경계 조건 수정 |

---

## 5. 주요 기술적 도전 및 해결

### 5.1 좌표계/방향 문제

#### 문제
- 로봇이 명령과 반대 방향으로 움직임
- IMU 각도가 예상과 반대로 측정됨

#### 원인
- 모터 배선/방향과 ROS 좌표계 불일치
- MPU6050 센서 축 방향 차이

#### 해결
```python
# 모터 방향 부호 반전 적용
vy = -marker_vy_kp * angle   # 좌우 이동
wz = -wz_calculated          # 회전

# IMU 각도 계산 방향 수정
turned = start_yaw - current_yaw   # (기존: current - start)
```

### 5.2 모터 출력 불균형

#### 문제
- 직진 명령시 한쪽으로 휘어짐
- 배터리 전압 저하시 모터 정지

#### 원인
- 개별 모터 특성 차이
- 7.4V 배터리의 전압 강하

#### 해결
```python
# 모터별 스케일 보정
Motor_B_Scale = 1.1   # FR 모터 10% 증가

# MAX_PWM 파라미터 추가
ros2 topic pub /arduino/set_param std_msgs/String "P 2500"
```

### 5.3 마커 추적 불안정

#### 문제
- 마커가 깜빡거림 (검출 불안정)
- 마커 분실시 로봇 정지

#### 원인
- 조명 변화, 카메라 흔들림
- 단순 검출만 사용 (예측 없음)

#### 해결
```python
# 칼만 필터 적용
- Process noise: 0.01
- Measurement noise: 0.05
- 예측 horizon: 2.0초

# 마커 미검출시 2초간 예측 위치 사용
if not marker_detected and tracking_duration < 2.0:
    use_predicted_pose()
```

### 5.4 회전 정확도

#### 문제
- 회전 각도 부족 또는 초과
- 회전 후 마커 시야 이탈

#### 원인
- 바닥 미끄러짐, 관성
- 회전 중 마커 추적 불가

#### 해결
```python
# IMU 기반 PD 제어
turn_kp = 1.5
turn_kd = 0.3
turn_tolerance = 0.07 rad (±4°)

# 회전 완료 후 ALIGN 상태 추가
# → 마커 재탐색 및 정렬
```

### 5.5 Stall(정지) 감지

#### 문제
- 모터가 멈췄는지 알 수 없음
- 막혀도 계속 명령만 전송

#### 원인
- 엔코더 없음 (피드백 불가)

#### 해결
```python
# IMU/마커 변화량으로 정지 감지
if yaw_change < 0.005:      # 회전 정지
    stall_count += 1
if angle_change < 0.01:     # 이동 정지
    stall_count += 1

# Boost 모드: 점진적 출력 증가
if stall_count >= 3:
    stall_boost += 0.002    # 최대 0.015까지
```

### 5.6 주차 정밀도

#### 문제
- 주차 슬롯 중앙에 정확히 멈추지 못함

#### 해결
```python
# 3단계 정렬 프로세스
1. PARK_ALIGN_MARKER: 마커 각도 정렬 (±3°)
2. PARK_ALIGN_RECT: 중앙선 정렬 (±1.5cm)
3. PARK_FINAL: 최종 거리 조정 (±2cm)
```

---

## 6. 마커 맵 레이아웃

### 6.1 전체 맵 (600cm × 1870cm)

```
     x=18   x=42.5  x=54.5  x=66   x=78   x=102
      |       |       |       |      |       |
y=18  |       |       |   0   |      |       |   ← HOME (시작점)
      |       |       |   ●   |      |       |
      |       |       |       |      |       |
y=54  2───────┼───────┼───1───┼──────┼───────3   ← 분기점
      ●       |       |   ●   |      |       ●
      |       |       |       |      |       |
y=82  |      16      17      18     19      |   ← 주차 Zone A
      |       ○       ○       ○      ○      |
      |       |       |       |      |       |
y=111 4───────5───────6───────7──────8───────9   ← 중앙 통로
      ●       ●       ●       ●      ●       ●
      |       |       |       |      |       |
y=136 |      20      21      22     23      |   ← 주차 Zone B
      |       ○       ○       ○      ○      |
      |       |       |       |      |       |
y=162 |      24      25      26     27      |   ← 주차 Zone C
      |       ○       ○       ○      ○      |
      |       |       |       |      |       |
y=187 10──────11──────12──────13─────14─────15  ← 하단
      ●       ●       ●       ●      ●       ●

● = 도로 마커 (ID 0-15)
○ = 주차 슬롯 마커 (ID 16-27)
```

### 6.2 마커 정보

| 구분 | ID 범위 | 개수 | 용도 |
|------|---------|------|------|
| 도로 마커 | 0-15 | 16개 | 주행 경로 안내 |
| Zone A | 16-19 | 4개 | 주차 슬롯 A1-A4 |
| Zone B | 20-23 | 4개 | 주차 슬롯 B1-B4 |
| Zone C | 24-27 | 4개 | 주차 슬롯 C1-C4 |

- ArUco Dictionary: DICT_4X4_50
- 마커 크기: 4cm × 4cm

---

## 7. 통신 프로토콜

### 7.1 Arduino 모터 프로토콜 (Serial 115200)

```
┌─────────────────────────────────────────────────┐
│ 명령 형식                                        │
├─────────────────────────────────────────────────┤
│ "V vx vy wz\n"  - 속도 (m/s, rad/s)             │
│ "D vx vy wz\n"  - 정규화 값 (-1.0 ~ 1.0)        │
│ "S\n"           - 정지                           │
│ "P 2500\n"      - MAX_PWM 설정                   │
│ "C 1 1.1\n"     - 모터 스케일 보정               │
├─────────────────────────────────────────────────┤
│ Watchdog: 200ms (명령 없으면 자동 정지)          │
└─────────────────────────────────────────────────┘
```

### 7.2 Arduino 로더 프로토콜 (Serial 9600)

```
┌─────────────────────────────────────────────────┐
│ 명령                                             │
├─────────────────────────────────────────────────┤
│ "1\n"  - LOAD (적재)                             │
│         Forward → Limit → Servo 180° → Back     │
│                                                  │
│ "2\n"  - UNLOAD (하역)                           │
│         Forward → Limit → Servo 0° → Back       │
├─────────────────────────────────────────────────┤
│ 응답: "completed\n"                              │
└─────────────────────────────────────────────────┘
```

### 7.3 MQTT 서버 프로토콜

```
┌─────────────────────────────────────────────────┐
│ 토픽: balemale/robot/{robotId}/*                 │
├─────────────────────────────────────────────────┤
│ 구독 (Subscribe)                                 │
│ ├─ /cmd       - 배차 결과, 경로 변경             │
│ ├─ /map       - 노드 위치 정보                   │
│ └─ /cmd/ack   - 명령 확인                        │
├─────────────────────────────────────────────────┤
│ 발행 (Publish)                                   │
│ ├─ /request/dispatch - 배차 요청                 │
│ │   {reqId, plate, nowNodeId, ts}               │
│ ├─ /event     - 이벤트 발생                      │
│ │   {reqId, vehicleId, eventType, ts}           │
│ ├─ /anomaly   - 이상 탐지                        │
│ │   {anomalyType, edgeId, nowNodeId}            │
│ └─ /heartbeat - 주기적 연결 확인                 │
└─────────────────────────────────────────────────┘
```

---

## 8. 주요 ROS2 토픽

### 8.1 센서 토픽

| 토픽 | 타입 | 설명 |
|------|------|------|
| `/cam_front/image_raw` | Image | 전방 카메라 영상 |
| `/cam_side/image_raw` | Image | 측면 카메라 영상 |
| `/imu/data` | Imu | IMU 데이터 (필터링됨) |

### 8.2 인식 토픽

| 토픽 | 타입 | 설명 |
|------|------|------|
| `/perception/markers` | MarkerArray | 검출된 마커들 |
| `/perception/tracked_marker` | TrackedMarker | 추적 중인 마커 (칼만) |
| `/perception/side_markers` | MarkerArray | 측면 마커 (주차용) |
| `/perception/anpr/detections` | DetectionArray | 번호판/장애물 검출 |

### 8.3 미션/제어 토픽

| 토픽 | 타입 | 설명 |
|------|------|------|
| `/mission/state` | String | 현재 FSM 상태 |
| `/mission/target_marker` | Int32 | 목표 마커 ID |
| `/control/cmd_vel` | Twist | 모터 속도 명령 |
| `/control/enable_drive` | Bool | 주행 활성화 |

### 8.4 적재 토픽

| 토픽 | 타입 | 설명 |
|------|------|------|
| `/loader/command` | LoaderCommand | 적재 명령 |
| `/loader/status` | LoaderStatus | 적재 상태 |

---

## 9. 전체 미션 플로우 예시

```
┌────────────────────────────────────────────────────────────────┐
│ 1. WAIT_VEHICLE                                                │
│    └─ ANPR 카메라가 번호판 "12가3456" 감지                      │
│    └─ /perception/anpr/detections 발행                         │
├────────────────────────────────────────────────────────────────┤
│ 2. RECOGNIZE                                                   │
│    └─ 서버에 번호판 조회 요청                                   │
│    └─ MQTT: /request/dispatch → 서버                           │
│    └─ 서버 응답: 슬롯 17번, 경로 [0→1→5→17]                    │
├────────────────────────────────────────────────────────────────┤
│ 3. LOAD                                                        │
│    └─ /loader/command (LOAD) 발행                              │
│    └─ 리프트 상승 → 차량 적재                                   │
│    └─ 완료: /loader/status (DONE)                              │
├────────────────────────────────────────────────────────────────┤
│ 4. DRIVE                                                       │
│    ┌─────────────────────────────────────────────────────────┐ │
│    │ 마커 0 → 1                                              │ │
│    │  └─ DRIVE → STOP → ADVANCE → TURNING(90°) → ALIGN      │ │
│    ├─────────────────────────────────────────────────────────┤ │
│    │ 마커 1 → 5                                              │ │
│    │  └─ DRIVE → STOP → ADVANCE → TURNING(-90°) → ALIGN     │ │
│    ├─────────────────────────────────────────────────────────┤ │
│    │ 마커 5 → 17                                             │ │
│    │  └─ DRIVE → STOP → 주차 모드 진입                       │ │
│    └─────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 5. PARK (슬롯 17)                                              │
│    └─ PARK_DETECT: 슬롯 마커 탐색                              │
│    └─ PARK_ALIGN_MARKER: 마커 각도 정렬 (±3°)                  │
│    └─ PARK_ALIGN_RECT: 중앙 정렬 (±1.5cm)                      │
│    └─ PARK_FINAL: 최종 위치 조정 (±2cm)                        │
├────────────────────────────────────────────────────────────────┤
│ 6. UNLOAD                                                      │
│    └─ /loader/command (UNLOAD) 발행                            │
│    └─ 리프트 하강 → 차량 하역                                   │
├────────────────────────────────────────────────────────────────┤
│ 7. RETURN_HOME                                                 │
│    └─ 역순 경로: 17 → 5 → 1 → 0                                │
│    └─ 홈(마커 0) 도착                                          │
├────────────────────────────────────────────────────────────────┤
│ 8. WAIT_VEHICLE                                                │
│    └─ 다음 차량 대기 (사이클 반복)                              │
└────────────────────────────────────────────────────────────────┘
```

---

## 10. 실행 방법

### 10.1 빌드

```bash
cd ~/balemaleEMBEDDED
colcon build
source install/setup.bash
```

### 10.2 실행 (3개 터미널)

```bash
# 터미널 1: 메인 시스템
ros2 launch robot_bringup system.launch.py

# 터미널 2: 로더 시리얼 브릿지
cd ~/testArduino && python3 serial_bridge.py

# 터미널 3: ANPR (번호판 인식)
conda activate anpr_310
ros2 run anpr_detector detector_node
```

### 10.3 디버깅 명령

```bash
# 상태 모니터링
ros2 topic echo /mission/state
ros2 topic echo /perception/tracked_marker

# 수동 테스트
ros2 topic pub --once /mission/test_cmd std_msgs/String "data: 'PLATE 12가3456'"

# 긴급 정지
ros2 topic pub /control/cmd_vel geometry_msgs/Twist "{}"
```

---

## 11. 성과 및 결론

### 11.1 구현 완료 기능

| 기능 | 상태 | 설명 |
|------|------|------|
| ArUco 마커 기반 자율주행 | ✅ | 28개 마커 네비게이션 |
| 칼만 필터 마커 추적 | ✅ | 안정적 추적, 2초 예측 |
| IMU 기반 정밀 회전 | ✅ | PD 제어, ±4° 정밀도 |
| 메카넘 휠 전방향 이동 | ✅ | 4륜 독립 제어 |
| 차량 적재/하역 자동화 | ✅ | 리프트 + 서보 제어 |
| 서버 연동 슬롯 배정 | ✅ | MQTT 통신 |
| 번호판 인식 (ANPR) | ✅ | YOLOv8 기반 |
| 장애물 감지 | ✅ | 거리 기반 이상 탐지 |

### 11.2 기술 스택

| 분야 | 기술 |
|------|------|
| OS/프레임워크 | Ubuntu 22.04, ROS2 Humble |
| 메인 보드 | Jetson Orin Nano |
| 언어 | Python 3, C++ (Arduino) |
| 영상처리 | OpenCV, ArUco |
| AI/딥러닝 | YOLOv8 (ANPR) |
| 통신 | MQTT, Serial UART, I2C |
| 필터링 | Kalman Filter, Complementary Filter |

### 11.3 향후 개선 방향

| 항목 | 현재 | 개선안 |
|------|------|--------|
| 위치 추정 | 마커 기반 | 엔코더 + SLAM 추가 |
| 경로 계획 | 고정 경로 | 동적 경로 계획 (A*) |
| 다중 로봇 | 단일 로봇 | Fleet 관리 시스템 |
| 장애물 회피 | 정지만 | 동적 회피 경로 |

---

## 12. 참고 문서

- [ARCHITECTURE.md](ARCHITECTURE.md) - 상세 아키텍처
- [PROTOCOLS.md](PROTOCOLS.md) - 통신 프로토콜 상세
- [PARAMETERS.md](PARAMETERS.md) - 파라미터 설정
- [MESSAGES.md](MESSAGES.md) - 커스텀 메시지 정의
