safety_manager_node:
  ros__parameters:
    publish_hz: 50

    # auto cmd watchdog
    watchdog_ms: 200

    # emergency active window (teleop publish 끊기면 이 시간 후 자동 복귀)
    emergency_timeout_ms: 300

    # hard clamp
    max_vx: 0.60
    max_vy: 0.60
    max_wz: 1.60

    # slew limits
    slew_vx: 2.0
    slew_vy: 2.0
    slew_wz: 4.0

    # keep emergency within clamp
    clamp_emergency: true

    # =========================
    # IMU Heading Hold (NEW)
    # =========================
    enable_heading_hold: true

    # IMU topic (너 시스템에 맞게 수정)
    imu_topic: /imu/data

    # If IMU driver provides fused orientation quaternion, use it as yaw (recommended)
    # If false or orientation invalid -> integrate gyro(z)
    use_orientation_yaw: true

    # gyro(z) bias compensation (rad/s). 필요하면 실측해서 넣기.
    gyro_bias_z: 0.0

    # engage conditions
    # - if |wz_cmd| < hold_wz_deadband AND moving -> heading hold engages
    hold_wz_deadband: 0.12

    # when |vx| or |vy| >= this, consider "moving"
    hold_engage_speed: 0.10

    # disable hold when |vy| is large (since vy strafe can intentionally change yaw on bad floors)
    hold_vy_allow: 0.20

    # optional: require IMU freshness (ms). 0 disables this check.
    hold_min_imu_age_ms: 0

    # PID gains for yaw hold
    # start with KI=0, tune KP/KD
    hold_kp: 2.8
    hold_ki: 0.0
    hold_kd: 0.06

    # integral clamp (anti-windup)
    hold_i_limit: 0.8

    # clamp final wz output for hold (DriveCmd wz normalized -1..1이면 1.0 추천)
    hold_max_wz: 1.0

    # reset I-term when hold disengages
    reset_integral_on_release: true
