# control_stack.yaml (v2 - Small Map 120x205cm)

control_stack_node:
  ros__parameters:
    # 토픽
    mission_state_topic: /mission/state
    turn_target_topic: /mission/turn_target_rad
    enable_drive_topic: /control/enable_drive
    lane_topic: /perception/lane
    marker_status_topic: /perception/marker_status
    parking_line_topic: /perception/parking_line
    slot_marker_topic: /perception/slot_marker_pose
    
    drive_cmd_topic: /control/drive_cmd
    driving_state_topic: /driving/state
    align_done_topic: /mission/align_done
    
    control_rate_hz: 30.0
    state_publish_rate_hz: 10.0
    
    # Timeout - 작은 맵용 (마커 전환 빈번)
    lane_timeout_sec: 1.0
    marker_timeout_sec: 2.0
    blind_timeout_sec: 1.5
    
    # ===== 속도 (작은 맵 120x205cm, 차량 30cm) =====
    # Lane follow
    lane_vx: 0.03          # 3cm/s
    lane_k_psi: 0.5
    lane_k_y: 0.8
    lane_v0: 0.05
    
    # Marker follow (라인 없을 때)
    marker_vx: 0.025       # 2.5cm/s
    marker_kp_x: 0.3
    marker_kp_yaw: 0.4
    
    # Blind (둘 다 없을 때)
    blind_vx: 0.02         # 2cm/s
    
    # Turning
    turn_wz: 0.3           # 느리게
    turn_tolerance_rad: 0.08
    
    # Advance to center
    advance_vx: 0.025
    advance_target_z: 0.10   # 10cm (작은 맵)
    advance_tolerance_z: 0.02
    
    # Align (정밀)
    align_kp_x: 0.5
    align_kp_y: 0.4
    align_kp_yaw: 0.3
    align_tolerance_xy: 0.015   # 1.5cm
    align_tolerance_yaw: 0.06   # ~3.4도
    align_max_v: 0.04
    
    # Park - Line
    park_line_vy: 0.025
    park_line_kp_offset: 0.3
    park_line_kp_angle: 0.2
    park_line_tolerance_offset: 0.03
    park_line_tolerance_angle: 0.08
    
    # Park - Slot
    park_slot_vx: 0.02
    park_slot_target_x: 0.08
    park_slot_tolerance: 0.015
    
    # Safety - 작은 맵 최대 속도
    max_vx: 0.05
    max_vy: 0.05
    max_wz: 0.5
    
    base_frame: base_link
    log_throttle_sec: 1.0


safety_manager_node:
  ros__parameters:
    auto_cmd_topic: /control/drive_cmd
    emergency_cmd_topic: /control/drive_cmd_emergency
    safe_cmd_topic: /control/drive_cmd_safe
    imu_topic: /imu/data
    
    watchdog_timeout_sec: 0.3
    emergency_timeout_sec: 0.3
    
    # Slew rate (작은 맵용 - 부드럽게)
    slew_rate_vx: 0.5
    slew_rate_vy: 0.5
    slew_rate_wz: 1.5
    
    # Speed limits
    max_vx: 0.05
    max_vy: 0.05
    max_wz: 0.5
    
    # IMU Heading Hold
    use_imu_heading_hold: true
    heading_hold_kp: 0.4
    heading_hold_ki: 0.04
    heading_hold_threshold_wz: 0.1
    heading_hold_min_v: 0.01
    heading_hold_max_vy: 0.04
    imu_timeout_sec: 0.2
    
    publish_rate_hz: 50.0
    base_frame: base_link