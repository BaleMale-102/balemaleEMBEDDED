# Robot Parameters Configuration
# All units: meters, radians, seconds

# ============================================
# Sensor Drivers
# ============================================
/cam_front:
  ros__parameters:
    device: "/dev/video0"
    width: 640
    height: 480
    fps: 30.0
    frame_id: "camera_front"
    camera_name: "cam_front"
    simulate: false
    calibration_file: "cam_front_calib.yaml"

/cam_side:
  ros__parameters:
    device: "/dev/video4"
    width: 640
    height: 480
    fps: 30.0
    frame_id: "camera_side"
    camera_name: "cam_side"
    simulate: false
    calibration_file: ""

/arduino_driver:
  ros__parameters:
    port: "/dev/ttyUSB0"
    baudrate: 115200
    timeout: 0.1
    simulate: false
    cmd_rate_hz: 20.0
    watchdog_timeout: 0.15            # Arduino watchdog: 200ms
    max_vx: 0.01                      # 속도 제한 (m/s)
    max_vy: 0.01
    max_wz: 0.1                       # 회전 제한 (rad/s)
    wz_offset: 0.0                    # 직진 보정 (왼쪽 돌면 음수)

/imu_node:
  ros__parameters:
    i2c_bus: 7                        # Jetson Orin Nano: bus 7
    i2c_address: 0x68
    publish_rate_hz: 100.0
    calib_samples: 200
    comp_alpha: 0.98                  # Complementary filter gyro weight
    frame_id: "imu_link"

# ============================================
# Perception Parameters
# ============================================
/marker_detector:
  ros__parameters:
    dictionary: "DICT_4X4_50"
    marker_size: 0.04                # 4cm markers
    publish_debug_image: true
    image_topic: "/cam_front/image_raw"
    camera_info_topic: "/cam_front/camera_info"
    frame_id: "camera_front_link"

/marker_tracker:
  ros__parameters:
    process_noise: 0.01
    measurement_noise: 0.05
    prediction_timeout: 2.0
    min_prediction_confidence: 0.3
    camera_offset_x: 0.10             # 카메라→base_link 전방 오프셋 (m)

/lane_detector:  # 비활성화
  ros__parameters:
    image_topic: "/cam_front/image_raw"
    publish_debug_image: true
    roi_top_ratio: 0.5
    roi_bottom_ratio: 1.0
    sobel_threshold: 50
    min_line_pixels: 100
    line_color: "black"
    kalman_q: 0.01
    kalman_r: 0.05

# ============================================
# Control Parameters
# ============================================
/motion_controller:
  ros__parameters:
    control_rate: 20.0
    max_vx: 0.008
    max_vy: 0.008
    max_wz: 0.05
    # Fallback (센서 없을 때)
    reverse_vx: 0.015
    # Lane following (비활성화)
    lane_vx: 0.004
    lane_vy_kp: 0.03
    lane_vy_ki: 0.0
    lane_vy_kd: 0.005
    lane_wz_kp: 0.3
    lane_wz_ki: 0.0
    lane_wz_kd: 0.05
    # Marker approach
    marker_vx_kp: 0.015
    marker_vy_kp: 0.005
    marker_wz_kp: 0.025
    marker_reach_distance: 0.25
    marker_min_distance: 0.08
    marker_lost_reach_distance: 0.35
    advance_vx: 0.02              # ADVANCE_TO_CENTER 전진 속도 (max_vx로 clamp됨)
    # Turn (PD 제어 + 오버슈팅 보정)
    turn_wz: 0.04                 # 최대 회전 속도 (rad/s)
    turn_wz_min: 0.015            # 최소 회전 속도
    turn_tolerance: 0.05          # 완료 허용 오차 (rad, ~3도)
    turn_kp: 1.5                  # 비례 게인
    turn_kd: 0.3                  # 미분 게인 (급정지 방지)
    turn_decel_zone: 0.5          # 감속 시작 구간 (rad, ~30도)

# ============================================
# Planning Parameters
# ============================================
/mission_manager:
  ros__parameters:
    update_rate: 10.0
    default_turn_angle: 1.57        # 90 degrees

/server_bridge:
  ros__parameters:
    mqtt_host: "localhost"
    mqtt_port: 1883
    mqtt_username: ""
    mqtt_password: ""
    car_id: "car_01"
    simulation: false
    status_rate: 2.0
