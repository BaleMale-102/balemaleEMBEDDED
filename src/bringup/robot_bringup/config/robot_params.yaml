# Robot Parameters Configuration
# All units: meters, radians, seconds

# ============================================
# Sensor Drivers
# ============================================
/cam_front:
  ros__parameters:
    device: "/dev/video0"
    width: 640
    height: 480
    fps: 30.0
    frame_id: "camera_front"
    camera_name: "cam_front"
    simulate: false
    calibration_file: "cam_front_calib.yaml"
    # Focus control (C920)
    autofocus: false                  # 오토포커스 비활성화 (Turn 시 흐려짐 방지)
    focus: 40                         # 고정 포커스 (0=무한대, 250=최근거리, 40≈30cm)

/cam_side:
  ros__parameters:
    device: "/dev/video2"
    width: 640
    height: 480
    fps: 30.0
    frame_id: "camera_side"
    camera_name: "cam_side"
    simulate: false
    calibration_file: "cam_side_calib.yaml"
    # Focus control (Brio 100 - fixed focus, no control needed)
    autofocus: false
    focus: 0

/arduino_driver:
  ros__parameters:
    port: "/dev/ttyUSB0"
    baudrate: 115200
    timeout: 0.1
    simulate: false
    cmd_rate_hz: 20.0
    watchdog_timeout: 0.15            # Arduino watchdog: 200ms
    max_vx: 0.01                      # 속도 제한 (m/s)
    max_vy: 0.015
    max_wz: 0.15                      # 회전 제한 (rad/s)
    wz_offset: 0.0                    # 직진 보정 (왼쪽 돌면 음수)

/imu_node:
  ros__parameters:
    i2c_bus: 7                        # Jetson Orin Nano: bus 7
    i2c_address: 0x68
    publish_rate_hz: 100.0
    calib_samples: 500
    comp_alpha: 0.98                  # Complementary filter gyro weight
    frame_id: "imu_link"

/loader_driver:
  ros__parameters:
    port: "/dev/ttyACM0"              # Loader Arduino (for direct mode)
    baudrate: 9600                    # carrying.ino uses 9600 baud
    timeout: 0.1
    status_rate_hz: 10.0
    simulate: false
    operation_duration: 15.0          # Fallback timeout (seconds)
    use_bridge: true                  # Use serial_bridge node (run separately)

# ============================================
# Perception Parameters
# ============================================
/marker_detector:
  ros__parameters:
    dictionary: "DICT_4X4_50"
    marker_size: 0.04                # 4cm markers
    publish_debug_image: true
    image_topic: "/cam_front/image_raw"
    camera_info_topic: "/cam_front/camera_info"
    frame_id: "camera_front_link"

/side_marker_detector:
  ros__parameters:
    dictionary: "DICT_4X4_50"
    marker_size: 0.04                # 4cm markers
    publish_debug_image: true
    image_topic: "/cam_side/image_raw"
    camera_info_topic: "/cam_side/camera_info"
    output_topic: "/perception/side_markers"
    frame_id: "camera_side_link"

/marker_tracker:
  ros__parameters:
    process_noise: 0.01
    measurement_noise: 0.05
    prediction_timeout: 2.0
    min_prediction_confidence: 0.3
    camera_offset_x: 0.10             # 카메라→base_link 전방 오프셋 (m)

/slot_line_detector:
  ros__parameters:
    image_topic: "/cam_side/image_raw"
    output_topic: "/perception/slot_rect"
    publish_debug_image: true
    show_debug_window: false
    # HSV thresholds for yellow tape
    hsv_low_h: 20
    hsv_low_s: 100
    hsv_low_v: 100
    hsv_high_h: 35
    hsv_high_s: 255
    hsv_high_v: 255
    # Detection parameters
    min_area: 500
    max_area: 50000
    min_aspect_ratio: 0.3
    max_aspect_ratio: 3.0
    # Pixel to meter conversion (approximate, tune as needed)
    pixel_to_meter: 0.001             # 1 pixel = 1mm

/lane_detector:  # 비활성화
  ros__parameters:
    image_topic: "/cam_front/image_raw"
    publish_debug_image: true
    roi_top_ratio: 0.5
    roi_bottom_ratio: 1.0
    sobel_threshold: 50
    min_line_pixels: 100
    line_color: "black"
    kalman_q: 0.01
    kalman_r: 0.05

/anpr_detector:
  ros__parameters:
    config_path: "/home/a102/balemaleAI/config.yaml"
    image_topic: "/cam_front/image_raw"
    publish_debug_image: true
    show_debug_window: false

# ============================================
# Control Parameters
# ============================================
/motion_controller:
  ros__parameters:
    control_rate: 20.0
    max_vx: 0.008
    max_vy: 0.015
    max_wz: 0.075
    # Fallback (센서 없을 때)
    reverse_vx: 0.015
    # Lane following (비활성화)
    lane_vx: 0.004
    lane_vy_kp: 0.03
    lane_vy_ki: 0.0
    lane_vy_kd: 0.005
    lane_wz_kp: 0.3
    lane_wz_ki: 0.0
    lane_wz_kd: 0.05
    # Marker approach
    marker_vx_kp: 0.015
    marker_vy_kp: 0.01
    marker_wz_kp: 0.025
    marker_reach_distance: 0.25
    marker_min_distance: 0.08
    marker_lost_reach_distance: 0.35
    marker_align_threshold: 0.1  # 좌우 정렬 임계값 (rad, ~8.5도) - 이 이상이면 정렬 먼저
    advance_vx: 0.02              # ADVANCE_TO_CENTER 전진 속도 (max_vx로 clamp됨)
    advance_time: 0.2             # ADVANCE_TO_CENTER 고정 전진 시간 (초)
    # Turn (PD 제어 + 오버슈팅 보정)
    turn_wz: 0.06                 # 최대 회전 속도 (rad/s)
    turn_wz_min: 0.0225           # 최소 회전 속도
    turn_tolerance: 0.07          # 완료 허용 오차 (rad, ~3도)
    turn_kp: 1.5                  # 비례 게인
    turn_kd: 0.3                  # 미분 게인 (급정지 방지)
    turn_decel_zone: 0.35         # 감속 시작 구간 (rad, ~20도)
    turn_scale: 1.0               # 턴 각도 스케일 (1.0=그대로, 1.1=10% 더 돌기)
    # Parking parameters
    park_creep_vx: 0.003          # PARK_DETECT 탐색 속도 (m/s)
    park_align_kp: 0.02           # 마커 정렬 P 게인
    park_rect_kp: 0.015           # 직사각형 정렬 P 게인
    park_final_kp: 0.02           # 최종 거리 조정 P 게인
    park_max_vx: 0.008            # 주차 시 최대 전후 속도 (m/s)
    park_max_vy: 0.01             # 주차 시 최대 좌우 속도 (m/s)
    park_min_speed: 0.003         # 주차 시 최소 속도 (m/s)
    park_marker_threshold: 0.05   # 마커 정렬 완료 임계값 (rad, ~3도)
    park_rect_threshold: 0.015    # 직사각형 정렬 완료 임계값 (m, 1.5cm)
    park_distance_threshold: 0.02 # 최종 거리 완료 임계값 (m, 2cm)
    park_target_distance: 0.15    # 목표 주차 거리 (m, 마커로부터 15cm)
    # Stall detection and power boost
    stall_check_interval: 0.5     # 스톨 체크 주기 (초)
    stall_boost_increment: 0.002  # 스톨 시 파워 증가량
    stall_max_boost: 0.015        # 최대 부스트 값
    stall_threshold_wz: 0.005     # 회전 스톨 임계값 (rad)
    stall_threshold_vy: 0.01      # 이동 스톨 임계값 (마커 각도 변화, rad)
    stall_pulse_duration: 0.15    # 펄스 모드 지속 시간 (초)
    # Post-turn marker search
    post_turn_search_timeout: 3.0 # Turn 후 마커 탐색 타임아웃 (초)

# ============================================
# Planning Parameters
# ============================================
/mission_manager:
  ros__parameters:
    update_rate: 10.0
    default_turn_angle: 1.57        # 90 degrees
    # Full mission config
    home_marker_id: 0               # Home position marker ID
    auto_start_waiting: true        # Auto-start WAIT_VEHICLE after IDLE
    car_id: "car_01"                # Vehicle identifier for server
    # State timeouts (seconds)
    timeout_stop_at_marker: 2.0     # STOP_AT_MARKER 대기 시간
    timeout_advance_to_center: 2.0  # ADVANCE_TO_CENTER 최대 시간 (advance_time보다 여유있게)
    timeout_align_to_marker: 10.0   # ALIGN_TO_MARKER 최대 시간 (VY+WZ+탐색 포함)
    timeout_stop_bump: 0.5          # STOP_BUMP 관성 안정화 시간
    timeout_turning: 30.0           # TURNING 최대 시간
    timeout_park: 30.0              # PARK 최대 시간 (legacy)
    # Full mission timeouts
    timeout_recognize: 60.0         # RECOGNIZE 인식+서버응답 대기 시간
    timeout_load: 30.0              # LOAD 적재 완료 대기 시간
    timeout_unload: 30.0            # UNLOAD 하역 완료 대기 시간
    timeout_return_home: 120.0      # RETURN_HOME 복귀 최대 시간
    # Parking sub-state timeouts
    timeout_park_detect: 10.0       # PARK_DETECT 탐색 시간
    timeout_park_recovery: 15.0     # PARK_RECOVERY 복구 시간
    timeout_park_align_marker: 15.0 # PARK_ALIGN_MARKER 정렬 시간
    timeout_park_align_rect: 10.0   # PARK_ALIGN_RECT 정렬 시간
    timeout_park_final: 10.0        # PARK_FINAL 최종 조정 시간
    # State transition delays (seconds)
    delay_stop_at_marker: 0.5       # STOP_AT_MARKER 후 다음 상태로 전환 대기
    delay_stop_bump: 0.3            # STOP_BUMP 후 다음 상태로 전환 대기

/server_bridge:
  ros__parameters:
    # MQTT broker (EC2 server)
    mqtt_host: "43.202.0.116"
    mqtt_port: 8000                 # balemale backend port
    mqtt_username: ""
    mqtt_password: ""
    # Robot identification
    robot_id: 1                     # Robot ID for MQTT topics (balemale/robot/{robot_id}/...)
    simulation: false
    # Publish rates
    heartbeat_rate: 1.0             # Heartbeat frequency (Hz)
    status_rate: 2.0                # Status update frequency (Hz)
